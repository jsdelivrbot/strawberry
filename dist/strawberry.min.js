var swby=swby||{};swby.lang={};var swby_global=this;swby.lang.namespace=function(namespace){var fragments=namespace.split(".");swby.lang.assert(fragments.length>0);var obj=swby_global;for(var i=0;i<fragments.length;++i){var nextObj=obj[fragments[i]];if(!nextObj){nextObj={};obj[fragments[i]]=nextObj}obj=nextObj}};swby.lang.assert=function(statement,opt_message){if(!statement)throw new Error(opt_message||"Assertion error")};swby.lang.inherits=function(childCtor,parentCtor){function tempCtor(){}tempCtor.prototype=parentCtor.prototype;childCtor.superClass_=parentCtor.prototype;childCtor.prototype=new tempCtor;childCtor.prototype.constructor=childCtor};swby.lang.abstractMethod=function(){throw new Error("Abstract method not implemented")};swby.lang.notImplementedMethod=function(){throw new Error("Method not implemented")};swby.lang.singleton=function(ctor){ctor.getInstance=function(){if(ctor.instance_){return ctor.instance_}return ctor.instance_=new ctor}};swby.lang.makeEnum=function(arr){var result={};arr.forEach(function(entry){result[entry]=entry});return result};var swby=swby||{};swby.promise={};swby.promise.isArray_=function(x){return x instanceof Array||typeof x=="array"};swby.promise.isFunction_=function(x){return typeof x=="function"};swby.promise.ifFunction_=function(x){if(swby.promise.isFunction_(x))return x;else return null};swby.promise.isObject_=function(x){var type=typeof x;return type=="object"&&x!=null||type=="function"};swby.promise.async_=function(fn,opt_context,opt_arg){setTimeout(fn.bind(opt_context,opt_arg),0)};swby.promise.State_={PENDING:0,FULFILLED:1,REJECTED:2};swby.promise.IPromise=function(){};swby.promise.IPromise.prototype.then=function(opt_onFulfilled,opt_onRejected,opt_context){};swby.promise.Promise_=function(){this.state_=swby.promise.State_.PENDING;this.children_=[]};swby.promise.Promise_.prototype.fulfill_=function(value){if(this.state_!=swby.promise.State_.PENDING)return;this.state_=swby.promise.State_.FULFILLED;this.value_=value;this.resolveAndClearChildren_()};swby.promise.Promise_.prototype.reject_=function(reason){if(this.state_!=swby.promise.State_.PENDING)return;this.state_=swby.promise.State_.REJECTED;this.reason_=reason;this.resolveAndClearChildren_()};swby.promise.Promise_.prototype.then=function(opt_onFulfilled,opt_onRejected,opt_context){var childPromise=new swby.promise.ChildPromise_(swby.promise.ifFunction_(opt_onFulfilled),swby.promise.ifFunction_(opt_onRejected),opt_context);if(this.state_==swby.promise.State_.PENDING)this.children_.push(childPromise);else swby.promise.async_(this.resolveChild_,this,childPromise);return childPromise};swby.promise.resolve_=function(promise,x){if(promise===x){promise.reject_(new TypeError)}else if(swby.promise.isObject_(x)){try{var x_then=x.then}catch(e){promise.reject_(e);return}if(swby.promise.isFunction_(x_then)){var called=false;try{x_then.call(x,function(y){if(called)return;called=true;swby.promise.resolve_(promise,y)},function(r){if(called)return;called=true;promise.reject_(r)})}catch(e){if(!called)promise.reject_(e)}}else{promise.fulfill_(x)}}else{promise.fulfill_(x)}};swby.promise.Promise_.prototype.resolveChild_=function(child){if(this.state_==swby.promise.State_.FULFILLED){if(child.onFulfilled_){try{var x=child.onFulfilled_.call(child.context_,this.value_)}catch(e){child.reject_(e);return}swby.promise.resolve_(child,x)}else{child.fulfill_(this.value_)}}else{swby.lang.assert(this.state_==swby.promise.State_.REJECTED);if(child.onRejected_){try{var x=child.onRejected_.call(child.context_,this.reason_)}catch(e){child.reject_(e);return}swby.promise.resolve_(child,x)}else{child.reject_(this.reason_)}}};swby.promise.Promise_.prototype.resolveAndClearChildren_=function(){var children=this.children_;this.children_=[];swby.promise.async_(function(){for(var i=0;i<children.length;++i){this.resolveChild_(children[i])}},this)};swby.promise.Promise=function(opt_fn,opt_context){swby.promise.Promise_.call(this);if(opt_fn){try{opt_fn.call(opt_context||this,this.fulfill_.bind(this),this.reject_.bind(this))}catch(e){this.reject_(e)}}};swby.lang.inherits(swby.promise.Promise,swby.promise.Promise_);swby.promise.ChildPromise_=function(opt_onFulfilled,opt_onRejected,opt_context){swby.promise.Promise.call(this);this.onFulfilled_=opt_onFulfilled;this.onRejected_=opt_onRejected;this.context_=opt_context};swby.lang.inherits(swby.promise.ChildPromise_,swby.promise.Promise);swby.promise.LazyPromise=function(opt_fn,opt_context){swby.promise.Promise_.call(this);if(opt_fn){this.lazyFn_=opt_fn.bind(opt_context||this)}};swby.lang.inherits(swby.promise.LazyPromise,swby.promise.Promise_);swby.promise.LazyPromise.prototype.then=function(opt_onFulfilled,opt_onRejected,opt_context){if(this.lazyFn_){try{this.lazyFn_(this.fulfill_.bind(this),this.reject_.bind(this))}catch(e){this.reject_(e)}this.lazyFn_=null}return swby.promise.Promise_.prototype.then.call(this,opt_onFulfilled,opt_onRejected,opt_context)};swby.promise.LazyPromise.prototype.forceFulfill=function(value){this.lazyFn_=null;this.fulfill_(value)};swby.promise.LazyPromise.prototype.forceReject=function(reason){this.lazyFn_=null;this.reject_(reason)};swby.promise.forEach_=function(obj,fn,opt_context){if(swby.promise.isArray_(obj)){obj.forEach(fn,opt_context)}else{for(var key in obj){fn.call(opt_context,obj[key],key)}}};swby.promise.getSize_=function(obj){if(swby.promise.isArray_(obj)){return obj.length}else{var length=0;for(var key in obj)++length;return length}};swby.promise.all=function(promises){var count=1;var compoundValue=swby.promise.isArray_(promises)?[]:{};var failed=false;return new swby.promise.Promise(function(fulfill,reject){function finalize(){--count;if(count==0)fulfill(compoundValue)}swby.promise.forEach_(promises,function(child,key){++count;child.then(function(value){if(failed)return;compoundValue[key]=value;finalize()},function(reason){if(failed)return;failed=true;reject(reason)})});finalize()})};swby.promise.any=function(promises){var count=1;var compoundReason=swby.promise.isArray_(promises)?[]:{};var fulfilled=false;return new swby.promise.Promise(function(fulfill,reject){function finalize(){--count;if(count==0)reject(compoundReason)}swby.promise.forEach_(promises,function(child,key){++count;child.then(function(value){if(fulfilled)return;fulfilled=true;fulfill(value)},function(reason){if(fulfilled)return;compoundReason[key]=reason;finalize()})});finalize()})};swby.promise.fulfilled=function(value){return new swby.promise.Promise(function(fulfill,reject){fulfill(value)})};swby.promise.rejected=function(reason){return new swby.promise.Promise(function(fulfill,reject){reject(reason)})};swby.promise.create=function(opt_fn,opt_context){return new swby.promise.Promise(opt_fn,opt_context)};swby.promise.AbortablePromise=function(opt_fn,opt_abort,opt_context){this.abort_=opt_abort;this.context_=opt_context||this;swby.promise.Promise.call(this,opt_fn,opt_context)};swby.lang.inherits(swby.promise.AbortablePromise,swby.promise.Promise);swby.promise.AbortablePromise.prototype.abort=function(){if(this.abort_)this.abort_.call(this.context_)};swby.promise.Timeout_=function(promise,delay){this.promise_=promise;swby.promise.Promise.call(this,function(fulfill,reject){this.reject_=reject;this.timeout_=setTimeout(this.onTimeout_.bind(this),delay);promise.then(function(value){if(!this.clearTimeout_())return;fulfill(value)},function(reason){if(!this.clearTimeout_())return;reject(reason)},this)},this)};swby.lang.inherits(swby.promise.Timeout_,swby.promise.Promise);swby.promise.Timeout_.onTimeout_=function(){if(!this.clearTimeout_())return;if(this.promise_.abort)this.promise_.abort();this.reject_("timeout")};swby.promise.Timeout_.clearTimeout_=function(){if(!this.timeout_)return false;clearTimeout(this.timeout_);this.timeout_=null;return true};swby.promise.timeout=function(promise,delay){return new swby.promise.Timeout_(promise,delay)};swby.promise.delay=function(time_ms){return new swby.promise.AbortablePromise(function(fulfill,reject){var zhis=this;this.delay_=setTimeout(function(){zhis.delay_=null;fulfill(null)},time_ms)},function(){if(this.delay_)clearTimeout(this.delay_)},this)};swby.promise.onDomEvent=function(target,eventType){return new swby.promise.AbortablePromise(function(fulfill,reject){var zhis=this;zhis.eventHandler_=function(event){target.removeEventListener(eventType,zhis.eventHandler_);fulfill(event)};target.addEventListener(eventType,this.eventHandler_,false)},function(){target.removeEventListener(eventType,this.eventHandler_)},this)};swby.lang.namespace("swby.util");swby.util.getAncestorByClass=function(element,className){while(element){if(element.classList.contains(className))return element;element=element.parentNode}return null};swby.util.getElementByClassName=function(element,className){var elements=element.getElementsByClassName(className);if(elements.length==0)return null;else return elements[0]};swby.util.clone=function(obj){var clone={};for(var key in obj)clone[key]=obj[key];return clone};swby.util.getSelectValue=function(el){var selectedIndex=el.selectedIndex;return selectedIndex>=0?el.options[selectedIndex].value:null};swby.util.forEach2=function(arr1,arr2,fn,opt_obj){swby.lang.assert(arr1.length==arr2.length);for(var i=0;i<arr1.length;++i){fn.call(opt_obj,arr1[i],arr2[i],i)}};swby.util.forEach3=function(arr1,arr2,arr3,fn,opt_obj){swby.lang.assert(arr1.length==arr2.length);swby.lang.assert(arr1.length==arr3.length);for(var i=0;i<arr1.length;++i){fn.call(opt_obj,arr1[i],arr2[i],arr3[i],i)}};swby.util.createDom=function(tagName,attributes,children){var element=document.createElement(tagName);if(attributes){if(typeof attributes=="string"){element.className=attributes}else{for(var key in attributes){if(key=="className")element.className=attributes[key];else element.setAttribute(key,attributes[key])}}}if(children){if(typeof children=="string"){element.textContent=children}else{children.forEach(function(child){if(child)element.appendChild(child)})}}return element};swby.util.getDate_=function(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate())};swby.util.numberOfDays_=function(d1,d2){var d1r=new swby.util.getDate_(d1);var d2r=new swby.util.getDate_(d2);return Math.round((d2r.getTime()-d1r.getTime())/(1e3*3600*24))};swby.util.padOnTwoDigits_=function(x){if(x<10)return"0"+x;else return""+x};swby.util.formatTime_=function(d){return swby.util.padOnTwoDigits_(d.getHours())+":"+swby.util.padOnTwoDigits_(d.getMinutes())};swby.util.DAYS_OF_WEEK_=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];swby.util.formatEventWhen=function(start,end){var now=new Date;var startDate=new Date(start);var endDate=new Date(end);var result="";var startDateInDays=swby.util.numberOfDays_(now,startDate);if(startDateInDays==0){result+="Today"}else if(startDateInDays>0&&startDateInDays<7){result+=swby.util.DAYS_OF_WEEK_[startDate.getDay()]}else{result+=start.substr(0,10)}result+=", "+swby.util.formatTime_(startDate)+" to "+swby.util.formatTime_(endDate);var endDateInDays=swby.util.numberOfDays_(startDate,endDate);if(endDateInDays!=0)result+=" (+"+endDateInDays+")";return result};swby.util.renderHtmlAsElement=function(html){var element=document.createElement("div");element.innerHTML=html;return element.firstElementChild};swby.lang.namespace("swby.base");swby.base.Disposable=function(){this.disposables_=[];this.disposed_=false};swby.base.Disposable.prototype.dispose=function(){if(this.isDisposed())return;this.disposables_.forEach(function(obj){obj.dispose()},this);this.disposeInternal_();this.disposed_=true};swby.base.Disposable.prototype.isDisposed=function(){return this.disposed_};swby.base.Disposable.prototype.disposeInternal_=function(){};swby.base.Disposable.prototype.registerDisposable=function(obj){this.disposables_.push(obj);return obj};swby.base.EventHandler=function(opt_this){swby.base.Disposable.call(this);this.this_=opt_this||this;this.handlers_=[]};swby.lang.inherits(swby.base.EventHandler,swby.base.Disposable);swby.base.EventHandler.prototype.dispose=function(){this.handlers_.forEach(function(entry){entry.target.removeEventListener(entry.eventType,entry.handler,entry.useCapture)},this);swby.base.EventHandler.prototype.dispose.call(this)};swby.base.EventHandler.prototype.listen=function(target,eventTypes,handler,opt_useCapture){var handler_binded=handler.bind(this.this_);if(typeof eventTypes=="string")eventTypes=[eventTypes];var useCapture=opt_useCapture||false;eventTypes.forEach(function(eventType){target.addEventListener(eventType,handler_binded,useCapture);this.handlers_.push({target:target,eventType:eventType,handler:handler_binded,useCapture:useCapture})},this)};swby.base.DialogFactory=function(){};swby.base.DialogFactory.prototype.showDialog=function(params,callback){};swby.base.AlertDialogFactory=function(){};swby.base.AlertDialogFactory.prototype.showDialog=function(params,callback){alert(params.title+(params.message?"\n\n"+params.message:"")+(params.details?"\n\n"+params.details:""));callback()};swby.base.BootstrapDialogFactory=function(){};swby.base.BootstrapDialogFactory.DIALOG_HTML_='  <div class="modal fade" id="my-modal">    <div class="modal-dialog">      <div class="modal-content">        <div class="modal-header">          <h4 class="modal-title lead"></h4>        </div>        <div class="modal-body"></div>        <div class="modal-footer">          <button type="button" class="btn" data-dismiss="modal">          </button>        </div>      </div>    </div>  </div>';swby.base.BootstrapDialogFactory.prototype.showDialog=function(params,callback){var cls=params.cls||"primary";var dialog=swby.util.renderHtmlAsElement(swby.base.BootstrapDialogFactory.DIALOG_HTML_);var title=swby.util.getElementByClassName(dialog,"modal-title");title.classList.add("text-"+cls);title.textContent=params.title;var body=swby.util.getElementByClassName(dialog,"modal-body");if(params.message){var p=document.createElement("p");p.textContent=params.message;body.appendChild(p)}if(params.details){var p=document.createElement("p");p.textContent=params.details;p.style="white-space: pre-wrap; font-size: 80%; font-family: monospace;";body.appendChild(p)}if(params.ok_label){var btn=swby.util.getElementByClassName(dialog,"btn");btn.classList.add("btn-"+cls);btn.textContent=params.ok_label;function clickListener(event){btn.removeEventListener("click",clickListener);callback()}btn.addEventListener("click",clickListener)}else{var footer=swby.util.getElementByClassName(dialog,"modal-footer");footer.style.display="none"}document.body.appendChild(dialog);$(dialog).modal("show");$(dialog).on("hidden.bs.modal",function(event){document.body.removeChild(dialog)})};swby.base.Error=function(message,details){this.message=message;this.details=details;this.stack=(new Error).stack};swby.lang.inherits(swby.base.Error,Error);swby.base.getErrorDetailsAsString_=function(details){function formatDetails(status,statusText){return"Error "+status+(statusText?": "+statusText:"")}if(typeof details=="string"){return details}else if(details.error&&details.error.code){return formatDetails(details.error.code,details.error.message)}else if(details.result&&details.result.error&&details.result.error.code){return formatDetails(details.result.error.code,details.result.error.message||details.statusText)}else if(details.status&&details.statusText){return formatDetails(details.status,details.statusText)}else{return null}};swby.base.getErrorDisplayInfo_=function(error){if(typeof error=="string"){return{message:error,details:null}}else if(error instanceof swby.base.Error){return{message:error.message,details:swby.base.getErrorDetailsAsString_(error.details)}}else if(error instanceof Error){return{message:error.message,details:null}}return{message:"Unknown error",details:null}};swby.base.reportError=function(dialogFactory,error,opt_fatal){var displayInfo=swby.base.getErrorDisplayInfo_(error);console.group(displayInfo.message);if(displayInfo.details)console.log(displayInfo.details);if(error.stack)console.log(error.stack);console.groupEnd();function finalize(){if(opt_fatal)document.body.innerHTML=""}if(dialogFactory){dialogFactory.showDialog({title:"Ooops! Something went wrong.",message:displayInfo.message,details:displayInfo.details,ok_label:opt_fatal?null:"Continue",cls:"danger"},finalize)}else{finalize()}};swby.base.Page=function(opt_initCallback){swby.base.EventHandler.call(this);this.initCallback_=opt_initCallback};swby.lang.inherits(swby.base.Page,swby.base.EventHandler);swby.base.Page.prototype.init=function(){this.loaded();if(this.initCallback_)this.initCallback_()};swby.base.Page.prototype.loaded=function(){document.body.classList.remove("swby-loading")};swby.base.Page.prototype.onload=swby.lang.abstractMethod;swby.base.Page.prototype.swbyIsPage_=true;swby.base.Config;swby.base.Loader=function(config,page_class,opt_dialogFactory){swby.base.EventHandler.call(this);this.config_=config;this.page_class_=page_class;this.page_=null;this.dialogFactory_=opt_dialogFactory||new swby.base.BootstrapDialogFactory;swby.promise.all([swby.promise.onDomEvent(document,"DOMContentLoaded").then(function(event){if(this.page_class_.prototype.swbyIsPage_){this.page_=new this.page_class_}else{this.page_=new swby.base.Page(this.page_class_)}},null,this),this.loadGoogleApi_().then(function(){return new swby.promise.all([this.loadApis_(),this.authorize_()])},null,this)]).then(function(){this.page_.init();window.setInterval(this.refreshToken_.bind(this),this.token_refresh_interval_ms_)},null,this).then(null,this.handleError_,this)};swby.lang.inherits(swby.base.Loader,swby.base.EventHandler);swby.base.Loader.prototype.gapi_callback_="gapi_onload";swby.base.Loader.prototype.gapi_url_="https://apis.google.com/js/client.js";swby.base.Loader.prototype.xhr_timeout_ms_=5e3;swby.base.Loader.prototype.get_token_path_="/oauth2/token";swby.base.Loader.prototype.token_lifetime_s_=50*60;swby.base.Loader.prototype.token_refresh_interval_ms_=45*60*1e3;swby.base.Loader.prototype.handleError_=function(error){swby.base.reportError(this.dialogFactory_,error,true)};swby.base.Loader.prototype.needGoogleApi_=function(){return this.config_.apis&&this.config_.apis.length>0||(this.config_.api_key||this.config_.get_token_from_server||this.config_.scopes&&this.config_.scopes.length>0)};swby.base.Loader.prototype.needGoogleApi_=function(){return!(swby_global.gapi&&swby_global.gapi.auth&&swby_global.gapi.client)};swby.base.Loader.prototype.googleApiCallbackPromise_=function(callbackName,opt_fn,opt_context){return new swby.promise.Promise(function(fulfill,reject){window[callbackName]=function(){delete window[callbackName];fulfill()};if(opt_fn)opt_fn.call(opt_context)},this)};swby.base.Loader.prototype.loadGoogleApi_=function(){if(this.needGoogleApi_()){return this.googleApiCallbackPromise_(this.gapi_callback_,function(){var url=this.gapi_url_+"?onload="+this.gapi_callback_;document.write('<script type="application/javascript" src="'+url+'"></script>')},this)}else{return swby.promise.fulfilled(null)}};swby.base.Loader.prototype.authorize_=function(){if(this.config_.api_key)gapi.auth.setApiKey(this.config_.api_key);if(this.config_.get_token_from_server){return this.getOAuth2TokenFromServer_()}else if(this.config_.scopes&&this.config_.scopes.length>0){return this.authorizeLocally_()}else{return swby.promise.fulfilled(null)}};swby.base.Loader.prototype.getOAuth2TokenFromServer_=function(){return new swby.promise.Promise(function(fulfill,reject){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(event){if(xhr.readyState!=4)return;if(xhr.status==200){try{var response=JSON.parse(xhr.responseText)}catch(e){var response=null}if(!response){reject(new swby.base.Error("Cannot get OAuth2 token","The server returned a malformed response:\n"+xhr.responseText))}else if(response.status==200){gapi.auth.setToken(response.result);fulfill(null)}else{reject(new swby.base.Error("Cannot get OAuth2 token",response))}}else if(xhr.status==0){reject(new swby.base.Error("Cannot get OAuth2 token","Timeout"))}else{reject(new swby.base.Error("Cannot get OAuth2 token",xhr))}}.bind(this);xhr.timeout=this.xhr_timeout_ms_;xhr.open("GET",this.get_token_path_+"?min_lifetime_seconds="+this.token_lifetime_s_);xhr.send()},this)};swby.base.Loader.prototype.authorizeLocallyAttempt_=function(immediate,fulfill,reject){var zhis=this;gapi.auth.authorize({client_id:this.config_.client_id,scope:this.config_.scopes.join(" "),immediate:immediate},function(result){if(result.error){if(immediate){zhis.showAuthDialog_(function(){zhis.authorizeLocallyAttempt_(false,fulfill,reject)})}else{reject(new swby.base.Error("Authorization failure",result.error))}}else{fulfill()}})};swby.base.Loader.prototype.authorizeLocally_=function(){return new swby.promise.Promise(function(fulfill,reject){this.authorizeLocallyAttempt_(true,fulfill,reject)},this)};swby.base.Loader.prototype.showAuthDialog_=function(callback){this.dialogFactory_.showDialog({title:"Authorization needed",message:"This application requires authorization to access some Google"+'APIs. Please click on "Proceed" to run through the'+"authorization process. This will open a popup window from "+"Google where you will be to review the access rights and "+"approve them.",ok_label:"Proceed"},callback)};swby.base.Loader.prototype.loadApis_=function(){var promises=[];this.config_.apis.forEach(function(api){var root=api.root;if(root&&root.charAt(0)=="/"&&root.charAt(1)!="/")root="//"+window.location.host+root;promises.push(new swby.promise.Promise(function(fulfill,reject){gapi.client.load(api.name,api.version,null,root).then(function(resp){if(resp&&resp.error){reject(new swby.base.Error('Cannot load API "'+api.name+'" ('+api.version+")",resp))}else{fulfill()}},reject,this)},this))},this);return swby.promise.all(promises)};swby.base.Loader.prototype.refreshToken_=function(){if(this.config_.get_token_from_server)this.getOAuth2TokenFromServer_();else this.authorize_()};swby.base.DefaultPage_=function(){swby.base.Page.call(this)};swby.lang.inherits(swby.base.DefaultPage_,swby.base.Page);swby.base.DefaultPage_.callbacks_=[];swby.base.DefaultPage_.prototype.init=function(){swby.base.DefaultPage_.callbacks_.forEach(function(callback){callback()});swby.base.DefaultPage_.callbacks_=null};swby.base.onceReady=function(callback){if(swby.base.DefaultPage_.callbacks_){swby.base.DefaultPage_.callbacks_.push(callback)}else{callback()}};swby.base.init=function(config,opt_cls){new swby.base.Loader(config,opt_cls||swby.base.DefaultPage_)};